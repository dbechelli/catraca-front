<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Confer√™ncia ICMS - CTe</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1800px; margin: 0 auto; background: rgba(255,255,255,0.95); border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); backdrop-filter: blur(10px); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .controls { padding: 30px; background: #f8f9fa; border-bottom: 2px solid #e9ecef; }
        .filters { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .filter-group { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .filter-group label { display: block; margin-bottom: 8px; color: #495057; font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .filter-group input, .filter-group select { width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; }
        .apply-filter-btn { grid-column: span 3; padding: 15px 30px; background: linear-gradient(135deg, #56d8e4 0%, #9f01ea 100%); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; }
        .action-buttons { margin-top: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .filter-divergencias-btn, .show-all-btn, .export-btn { padding: 12px 25px; background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .show-all-btn { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
        .export-btn { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .stats { padding: 20px 30px; background: #f8f9fa; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px; }
        .stat-card { background: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-width: 160px; text-align: center; }
        .stat-card h3 { color: #6c757d; font-size: 0.8rem; margin-bottom: 8px; text-transform: uppercase; }
        .stat-card .value { font-size: 1.5rem; font-weight: bold; }
        .table-container { padding: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 20px rgba(0,0,0,0.1); font-size: 0.75rem; min-width: 1950px; }
        thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        th { padding: 10px 6px; text-align: left; font-weight: 600; font-size: 0.7rem; white-space: nowrap; position: sticky; top: 0; z-index: 10; }
        td { padding: 8px 6px; border-bottom: 1px solid #f0f0f0; font-size: 0.7rem; }
        .input-percent { width: 60px; padding: 4px; border: 2px solid #e9ecef; border-radius: 4px; text-align: center; font-weight: 600; }
        .divergencia-frete { background-color: #f8d7da !important; }
        .divergencia-icms { background-color: #fff3cd !important; }
        .alert-icon { display: inline-block; width: 16px; height: 16px; background: #dc3545; color: white; border-radius: 50%; text-align: center; line-height: 16px; font-weight: bold; font-size: 0.6rem; margin-right: 3px; }
        .currency { color: #28a745; font-weight: 600; text-align: right; }
        .percent { color: #007bff; font-weight: 600; text-align: center; }
        .loading { text-align: center; padding: 50px; font-size: 1.2rem; color: #6c757d; }
        .highlight-calc { background-color: #e7f5ff; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöö Sistema de Confer√™ncia ICMS - CTe</h1>
            <p>Sistema de valida√ß√£o e confer√™ncia de ICMS em documentos de transporte</p>
        </div>

        <div class="controls">
            <div class="filters">
                <div class="filter-group">
                    <label for="tomadorFilter">Tomador:</label>
                    <select id="tomadorFilter">
                        <option value="">Carregue os dados...</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="dataInicio">Data In√≠cio:</label>
                    <input type="date" id="dataInicio">
                </div>
                <div class="filter-group">
                    <label for="dataFim">Data Fim:</label>
                    <input type="date" id="dataFim">
                </div>
                <button class="apply-filter-btn" onclick="applyFilter()" id="filterBtn">
                    üîç Aplicar Filtro
                </button>
            </div>
            
            <div class="action-buttons" id="actionButtons" style="display: none;">
                <button class="filter-divergencias-btn" onclick="filterDivergencias()" id="filterDivergenciasBtn">
                    ‚ö†Ô∏è Mostrar Apenas Diverg√™ncias
                </button>
                <button class="show-all-btn" onclick="showAll()" id="showAllBtn" style="display: none;">
                    üìã Mostrar Todos
                </button>

                <button class="export-btn" onclick="exportErrorsExcel()" id="btnExportErrors" disabled>
                    ‚¨áÔ∏è Exportar Erros
                </button>
                <button class="export-btn" onclick="exportAllExcel()" id="btnExportAll" disabled>
                    ‚¨áÔ∏è Exportar Tudo
                </button>
            </div>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card"><h3>Total Registros</h3><div class="value" id="totalRegistros">0</div></div>
            <div class="stat-card"><h3>Diverg√™ncias Frete</h3><div class="value" id="totalDivergenciasFrete">0</div></div>
            <div class="stat-card"><h3>Diverg√™ncias ICMS</h3><div class="value" id="totalDivergenciasIcms">0</div></div>
            <div class="stat-card"><h3>Valor Total Frete</h3><div class="value" id="valorTotalFrete">R$ 0,00</div></div>
            <div class="stat-card"><h3>Valor Total ICMS</h3><div class="value" id="valorTotalIcms">R$ 0,00</div></div>
        </div>

        <div class="table-container" id="tableContainer" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th style="min-width: 80px;">Emissor</th>
                        <th style="min-width: 120px;">N¬∫ CTe</th>
                        <th style="min-width: 120px;">Tomador</th>
                        <th style="min-width: 150px;">Destinat√°rio</th>
                        <th style="min-width: 80px;">Data Emiss√£o</th>
                        <th style="min-width: 100px;">Valor Mercadoria</th>
                        <th style="min-width: 110px;">Valor Total Frete</th>
                        <th style="min-width: 100px;">Valor Frete (CTe)</th>
                        <th style="min-width: 110px;" class="highlight-calc">Frete Sem ICMS</th>
                        <th style="min-width: 70px;">Seguro</th>
                        <th style="min-width: 90px;">Valor Despacho</th>
                        <th style="min-width: 70px;">% Informado</th>
                        <th style="min-width: 100px;">Valor Calculado</th>
                        <th style="min-width: 80px;">Status Frete</th>
                        <th style="min-width: 100px;">Base C√°lc. ICMS</th>
                        <th style="min-width: 80px;">Valor ICMS</th>
                        <th style="min-width: 60px;">Al√≠q. ICMS</th>
                        <th style="min-width: 100px;">ICMS Calculado</th>
                        <th style="min-width: 80px;">Status ICMS</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="loading" id="loading" style="display: none;">Processando dados...</div>
    </div>

    <script>
        // Estado
        let filteredData = [];
        let allFilteredData = [];
        let percentuaisInformados = {}; // salvar percentuais por √≠ndice

        // Inicializar datas e carregar tomadores (tenta rota, se falhar mantem vazio)
        document.addEventListener('DOMContentLoaded', () => {
            const hoje = new Date();
            const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            document.getElementById('dataInicio').value = primeiroDia.toISOString().split('T')[0];
            document.getElementById('dataFim').value = hoje.toISOString().split('T')[0];
            // tomador ser√° preenchido ap√≥s a primeira chamada √† API (esquema antigo)
        });

        // Tomador agora ser√° preenchido automaticamente ap√≥s carregar dados da API
        function updateTomadorDropdownFromData(data) {
            const sel = document.getElementById('tomadorFilter');

            // Limpa op√ß√µes atuais
            sel.innerHTML = '<option value="">Todos</option>';

            // Extrai tomadores √∫nicos
            const unique = [...new Set(data.map(r => r.tomador).filter(t => t && t.trim() !== ''))];

            unique.sort().forEach(t => {
                const op = document.createElement('option');
                op.value = t;
                op.textContent = t;
                sel.appendChild(op);
            });
        }

        // Chamado ao clicar em Aplicar Filtro
        async function applyFilter() {
            const tomador = document.getElementById('tomadorFilter').value || '';
            const di = document.getElementById('dataInicio').value;
            const df = document.getElementById('dataFim').value;

            document.getElementById('loading').style.display = 'block';

            const url = `https://apicatraca.visualsoftia.cloud/api/registros/conferencia-icms-cte?tomador=${encodeURIComponent(tomador)}&data_inicio=${encodeURIComponent(di)}&data_fim=${encodeURIComponent(df)}`;
            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('Erro na API');
                const data = await resp.json();

                // normalizar campos - assumir nomes da function
                filteredData = data.map(r => ({
                    emissor: r.emissor,
                    numero_cte: r.numero_cte,
                    tomador: r.tomador,
                    destinatario: r.destinatario,
                    data_emissao: r.data_emissao,
                    valor_mercadoria: r.valor_mercadoria,
                    valor_total_frete: r.valor_total_frete,
                    valor_frete_cte: r.valor_frete_cte,
                    frete_sem_icms: r.frete_sem_icms,
                    seguro: r.seguro,
                    valor_despacho: r.valor_despacho,
                    base_calculo_icms: r.base_calculo_icms,
                    valor_icms: r.valor_icms,
                    aliq_icms: r.aliq_icms,
                    icms_calculado: r.icms_calculado,
                    status_icms: r.status_icms,
                    _divergencia_frete: false // marca atualiz√°vel no front
                }));

                // preencher o select Tomador com base nos dados retornados
                updateTomadorDropdownFromData(filteredData);

                allFilteredData = [...filteredData];
                displayTable();
                updateStats();

                document.getElementById('tableContainer').style.display = filteredData.length ? 'block' : 'none';
                document.getElementById('stats').style.display = filteredData.length ? 'flex' : 'none';
                document.getElementById('actionButtons').style.display = filteredData.length ? 'block' : 'none';

                document.getElementById('btnExportAll').disabled = filteredData.length === 0;
                document.getElementById('btnExportErrors').disabled = filteredData.length === 0;

            } catch (err) {
                alert('Erro ao carregar dados da API');
                console.error(err);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (!filteredData || filteredData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="19" style="text-align:center;padding:40px;color:#6c757d;"><h3>Nenhum registro encontrado</h3><p>Verifique os filtros aplicados</p></td></tr>`;
                return;
            }

            filteredData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.dataset.index = index;

                // identificar diverg√™ncia icms j√° vinda do BD
                const divergenciaIcms = row.status_icms && row.status_icms !== 'OK';
                if (divergenciaIcms) tr.classList.add('divergencia-icms');
                if (row._divergencia_frete) tr.classList.add('divergencia-frete');

                tr.innerHTML = `
                    <td>${row.emissor || ''}</td>
                    <td>${row.numero_cte || ''}</td>
                    <td>${row.tomador || ''}</td>
                    <td>${row.destinatario || ''}</td>
                    <td>${formatDate(row.data_emissao)}</td>
                    <td class="currency">${formatCurrency(row.valor_mercadoria)}</td>
                    <td class="currency">${formatCurrency(row.valor_total_frete)}</td>
                    <td class="currency">${formatCurrency(row.valor_frete_cte)}</td>
                    <td class="currency highlight-calc">${formatCurrency(row.frete_sem_icms)}</td>
                    <td class="currency">${formatCurrency(row.seguro)}</td>
                    <td class="currency">${formatCurrency(row.valor_despacho)}</td>
                    <td><input type="number" class="input-percent" step="0.01" placeholder="0,00" onchange="calculateFreteValue(${index}, this.value)"></td>
                    <td class="currency" id="valorFreteCalculado-${index}">R$ 0,00</td>
                    <td id="statusFrete-${index}">-</td>
                    <td class="currency">${formatCurrency(row.base_calculo_icms)}</td>
                    <td class="currency">${formatCurrency(row.valor_icms)}</td>
                    <td class="percent">${formatPercent(row.aliq_icms)}</td>
                    <td class="currency">${formatCurrency(row.icms_calculado)}</td>
                    <td id="statusIcms-${index}">${row.status_icms || 'OK'}</td>
                `;

                tbody.appendChild(tr);
            });

            // restaurar percentuais informados
            Object.keys(percentuaisInformados).forEach(k => {
                const input = document.querySelector(`tr[data-index="${k}"] .input-percent`);
                if (input) { input.value = percentuaisInformados[k]; calculateFreteValue(parseInt(k), percentuaisInformados[k]); }
            });
        }

        function calculateFreteValue(index, percentInformado) {
            const row = filteredData[index];
            const valorMercadoria = parseNumber(row.valor_mercadoria);
            const freteValor = parseNumber(row.valor_frete_cte);
            const aliqIcms = parseNumber(row.aliq_icms);

            if (percentInformado && percentInformado !== '') {
                percentuaisInformados[index] = percentInformado;
            } else {
                delete percentuaisInformados[index];
            }

            const tr = document.querySelector(`tr[data-index="${index}"]`);
            const valorCalculadoCell = document.getElementById(`valorFreteCalculado-${index}`);
            const statusFreteCell = document.getElementById(`statusFrete-${index}`);

            if (!percentInformado || percentInformado === '') {
                valorCalculadoCell.innerHTML = 'R$ 0,00';
                statusFreteCell.innerHTML = '-';
                if (tr) tr.classList.remove('divergencia-frete');
                row._divergencia_frete = false;
                updateStats();
                return;
            }

            const valorFreteCalculado = valorMercadoria * (parseFloat(percentInformado) / 100);
            valorCalculadoCell.innerHTML = formatCurrency(valorFreteCalculado);

            // frete_sem_icms j√° vem do BD
            const freteSemIcms = parseNumber(row.frete_sem_icms);
            const diferenca = Math.abs(valorFreteCalculado - freteSemIcms);

            if (diferenca > 1) {
                if (tr) tr.classList.add('divergencia-frete');
                statusFreteCell.innerHTML = '<span class="alert-icon">!</span>Diverg√™ncia';
                row._divergencia_frete = true;
            } else {
                if (tr) tr.classList.remove('divergencia-frete');
                statusFreteCell.innerHTML = 'OK';
                row._divergencia_frete = false;
            }

            updateStats();
        }

        function parseNumber(value) {
            if (value === null || value === undefined || value === '') return 0;
            if (typeof value === 'number') return value;
            const v = value.toString().replace(/[R$\s\.]/g, '').replace(',', '.');
            return parseFloat(v) || 0;
        }

        function formatCurrency(value) {
            const v = parseNumber(value);
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
        }

        function formatPercent(value) {
            if (value === null || value === undefined || isNaN(value)) return '0,00%';
            return parseFloat(value).toFixed(2).replace('.', ',') + '%';
        }

        function formatDate(d) {
            if (!d) return '';
            const dt = new Date(d);
            if (!isNaN(dt)) return dt.toLocaleDateString('pt-BR');
            return d;
        }

        function updateStats() {
            const totalRegistros = filteredData.length;
            const divergenciasFrete = filteredData.filter(r => r._divergencia_frete).length;
            const divergenciasIcms = filteredData.filter(r => r.status_icms && r.status_icms !== 'OK').length;
            const valorTotal = filteredData.reduce((s,r)=> s + parseNumber(r.valor_total_frete),0);
            const valorTotalIcms = filteredData.reduce((s,r)=> s + parseNumber(r.valor_icms),0);

            document.getElementById('totalRegistros').textContent = totalRegistros;
            document.getElementById('totalDivergenciasFrete').textContent = divergenciasFrete;
            document.getElementById('totalDivergenciasIcms').textContent = divergenciasIcms;
            document.getElementById('valorTotalFrete').textContent = formatCurrency(valorTotal);
            document.getElementById('valorTotalIcms').textContent = formatCurrency(valorTotalIcms);

            document.getElementById('btnExportAll').disabled = totalRegistros === 0;
            document.getElementById('btnExportErrors').disabled = totalRegistros === 0;
        }

        function filterDivergencias() {
            const tbody = document.getElementById('tableBody');
            const rows = tbody.querySelectorAll('tr');
            let hasAny = false;
            rows.forEach(r => {
                if (!r.classList.contains('divergencia-frete') && !r.classList.contains('divergencia-icms')) r.style.display = 'none'; else { r.style.display=''; hasAny=true; }
            });
            if (!hasAny) tbody.innerHTML = `<tr><td colspan="19" style="text-align:center;padding:40px;color:#28a745;"><h3>‚úÖ Nenhuma diverg√™ncia encontrada!</h3><p>Todos os valores est√£o corretos</p></td></tr>`;
            document.getElementById('filterDivergenciasBtn').style.display='none';
            document.getElementById('showAllBtn').style.display='inline-block';
        }

        function showAll() { filteredData = [...allFilteredData]; displayTable(); updateStats(); document.getElementById('filterDivergenciasBtn').style.display='inline-block'; document.getElementById('showAllBtn').style.display='none'; }

        // Export para Excel usando SheetJS
        function exportAllExcel() {
            if (!filteredData || filteredData.length === 0) return alert('Sem dados para exportar');
            const wb = XLSX.utils.book_new();
            const sheet = XLSX.utils.json_to_sheet(filteredData.map(r => ({
                Emissor: r.emissor,
                'N¬∫ CTe': r.numero_cte,
                Tomador: r.tomador,
                Destinatario: r.destinatario,
                'Data Emiss√£o': r.data_emissao,
                'Valor Mercadoria': r.valor_mercadoria,
                'Valor Total Frete': r.valor_total_frete,
                'Valor Frete (CTe)': r.valor_frete_cte,
                'Frete Sem ICMS': r.frete_sem_icms,
                Seguro: r.seguro,
                'Valor Despacho': r.valor_despacho,
                'Base C√°lc. ICMS': r.base_calculo_icms,
                'Valor ICMS': r.valor_icms,
                'Al√≠q. ICMS': r.aliq_icms,
                'ICMS Calculado': r.icms_calculado,
                'Status ICMS': r.status_icms
            })));
            XLSX.utils.book_append_sheet(wb, sheet, 'Todos');
            XLSX.writeFile(wb, `conferencia_icms_todos_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function exportErrorsExcel() {
            if (!filteredData || filteredData.length === 0) return alert('Sem dados para exportar');
            const errors = filteredData.filter(r => (r.status_icms && r.status_icms !== 'OK') || r._divergencia_frete);
            if (errors.length === 0) return alert('Sem diverg√™ncias para exportar');
            const wb = XLSX.utils.book_new();
            const sheet = XLSX.utils.json_to_sheet(errors.map(r => ({
                Emissor: r.emissor,
                'N¬∫ CTe': r.numero_cte,
                Tomador: r.tomador,
                Destinatario: r.destinatario,
                'Data Emiss√£o': r.data_emissao,
                'Valor Mercadoria': r.valor_mercadoria,
                'Valor Total Frete': r.valor_total_frete,
                'Valor Frete (CTe)': r.valor_frete_cte,
                'Frete Sem ICMS': r.frete_sem_icms,
                Seguro: r.seguro,
                'Valor Despacho': r.valor_despacho,
                'Status ICMS': r.status_icms,
                'Diverg√™ncia Frete': r._divergencia_frete ? 'SIM' : 'NAO'
            })));
            XLSX.utils.book_append_sheet(wb, sheet, 'Erros');
            XLSX.writeFile(wb, `conferencia_icms_erros_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

    </script>
</body>
</html>